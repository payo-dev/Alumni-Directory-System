CREATE DATABASE IF NOT EXISTS `old_alumni_db` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE `old_alumni_db`;

CREATE TABLE `admin_account` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(50) NOT NULL,
  `password` VARCHAR(255) NOT NULL,
  `full_name` VARCHAR(100) NOT NULL,
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO `admin_account` (`username`, `password`, `full_name`) VALUES
('payo.dev', '$2y$10$vcOE7oFpHYjuZbrYbksU1eI/FpRd3oVxellwjXb/pY.euhXUlHxQa', 'Mathew Payopelin'),
('sirJaydee', '$2y$10$KkcTS90stTIPib0Va/7/qe.lrKVCaXP6jumaY478VasT1ZZNJXFuW', 'Jaydee Ballaho');

CREATE TABLE `alumni` (
  `student_id` VARCHAR(20) NOT NULL,
  `type_of_application` ENUM('New','Renewal') DEFAULT 'New',
  `renewal_status` ENUM('none','pending','approved','rejected') DEFAULT 'none',
  `picture_path` VARCHAR(255) DEFAULT NULL,
  `batch_name` VARCHAR(100) DEFAULT NULL,
  `surname` VARCHAR(100) NOT NULL,
  `given_name` VARCHAR(100) NOT NULL,
  `middle_name` VARCHAR(100) DEFAULT NULL,
  `region` VARCHAR(100) DEFAULT NULL,
  `province` VARCHAR(100) DEFAULT NULL,
  `city_municipality` VARCHAR(100) DEFAULT NULL,
  `barangay` VARCHAR(100) DEFAULT NULL,
  `contact_number` VARCHAR(20) DEFAULT NULL,
  `email` VARCHAR(150) NOT NULL,
  `birthday` DATE DEFAULT NULL,
  `blood_type` ENUM('A+','A-','B+','B-','AB+','AB-','O+','O-') DEFAULT NULL,
  `elementary_school` VARCHAR(150) DEFAULT NULL,
  `elementary_yr` YEAR(4) DEFAULT NULL,
  `junior_high_school` VARCHAR(150) DEFAULT NULL,
  `junior_high_yr` YEAR(4) DEFAULT NULL,
  `senior_high_school` VARCHAR(150) DEFAULT NULL,
  `senior_high_yr` YEAR(4) DEFAULT NULL,
  `tertiary_school` VARCHAR(150) DEFAULT NULL,
  `tertiary_yr` YEAR(4) DEFAULT NULL,
  `graduate_school` VARCHAR(150) DEFAULT NULL,
  `graduate_yr` YEAR(4) DEFAULT NULL,
  `company_name` VARCHAR(150) DEFAULT NULL,
  `position` VARCHAR(100) DEFAULT NULL,
  `company_address` VARCHAR(200) DEFAULT NULL,
  `company_contact` VARCHAR(30) DEFAULT NULL,
  `emergency_name` VARCHAR(150) DEFAULT NULL,
  `emergency_address` VARCHAR(200) DEFAULT NULL,
  `emergency_contact` VARCHAR(30) DEFAULT NULL,
  `status` ENUM('pending','active','archived') DEFAULT 'pending',
  `is_approved` TINYINT(1) DEFAULT 0,
  `validated_by` VARCHAR(100) DEFAULT NULL,
  `validated_date` DATETIME DEFAULT NULL,
  `issued_date` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `ccs_alumni` (
  `student_id` VARCHAR(20) NOT NULL,
  `course` ENUM('BSCS','BSIT','ACT') NOT NULL,
  `year_graduated` YEAR(4) NOT NULL,
  `surname` VARCHAR(100) NOT NULL,
  `firstname` VARCHAR(100) NOT NULL,
  PRIMARY KEY (`student_id`),
  CONSTRAINT `fk_ccs_alumni_student` FOREIGN KEY (`student_id`) REFERENCES `alumni` (`student_id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE OR REPLACE VIEW `alumni_with_year` AS
SELECT
  a.*,
  COALESCE(c.year_graduated, a.tertiary_yr, a.graduate_yr) AS grad_year
FROM alumni a
LEFT JOIN ccs_alumni c ON c.student_id = a.student_id;

COMMIT;